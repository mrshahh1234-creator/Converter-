<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>GibLab to Nanxing Converter</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <style>
        body { font-family: sans-serif; line-height: 1.6; max-width: 800px; margin: 40px auto; padding: 20px; background: #f4f4f9; }
        .container { background: white; padding: 30px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        h1 { color: #333; border-bottom: 2px solid #005bb5; padding-bottom: 10px; }
        .upload-area { border: 2px dashed #005bb5; padding: 40px; text-align: center; cursor: pointer; margin: 20px 0; transition: 0.3s; }
        .upload-area:hover { background: #eef6ff; }
        button { background: #005bb5; color: white; border: none; padding: 12px 24px; border-radius: 4px; cursor: pointer; font-size: 16px; }
        button:disabled { background: #ccc; }
        #status { margin-top: 20px; font-weight: bold; }
    </style>
</head>
<body>

<div class="container">
    <h1>Конвертер GibLab → Nanxing</h1>
    <p>Выберите файл <b>.project</b> для генерации списка раскроя (CSV) и программ присадки (NC).</p>
    
    <div class="upload-area" id="drop-zone">
        Перетащите файл сюда или <br>
        <input type="file" id="file-input" accept=".project" style="display:none">
        <button onclick="document.getElementById('file-input').click()">Выберите файл</button>
    </div>

    <div id="status"></div>
    <button id="download-btn" style="display:none">Скачать пакет для станков (.zip)</button>
</div>

<script>
    const fileInput = document.getElementById('file-input');
    const dropZone = document.getElementById('drop-zone');
    const status = document.getElementById('status');
    const downloadBtn = document.getElementById('download-btn');
    let zipResult = null;

    fileInput.onchange = (e) => handleFile(e.target.files[0]);

    function handleFile(file) {
        if (!file) return;
        const reader = new FileReader();
        status.innerText = "Обработка...";
        
        reader.onload = async (e) => {
            try {
                const parser = new DOMParser();
                const xmlDoc = parser.parseFromString(e.target.result, "text/xml");
                await processProject(xmlDoc);
            } catch (err) {
                status.innerText = "Ошибка при чтении файла!";
                console.error(err);
            }
        };
        reader.readAsText(file);
    }

    async function processProject(xml) {
        const zip = new JSZip();
        let csvContent = "\uFEFFНазвание;Длина;Ширина;Кол-во;Материал;Программа\n";
        
        // 1. Собираем детали для раскроя
        const parts = xml.getElementsByTagName("part");
        for (let part of parts) {
            const name = part.getAttribute("name") || "Без имени";
            const dw = part.getAttribute("dw") || "0";
            const dl = part.getAttribute("dl") || "0";
            const count = part.getAttribute("count") || "1";
            const id = part.getAttribute("id");
            const progName = `PROG_${id}.nc`;
            
            csvContent += `${name};${dw};${dl};${count};ЛДСП;${progName}\n`;
        }
        zip.file("nesting_list.csv", csvContent);

        // 2. Генерируем NC файлы для присадки
        const operations = xml.querySelectorAll("operation[typeId='XNC']");
        operations.forEach(op => {
            const partId = op.querySelector("part").getAttribute("id");
            let progXmlStr = op.getAttribute("program");
            
            // Декодируем XML внутри атрибута
            const pDoc = new DOMParser().parseFromString(progXmlStr, "text/xml");
            let gcode = `% \nO${partId} (Part ID: ${partId})\nG90 G21 G17\n`;

            // Парсим отверстия в пласть (bt и bb)
            const holes = pDoc.querySelectorAll("bt, bb");
            holes.forEach(h => {
                const x = h.getAttribute("x");
                const y = h.getAttribute("y");
                const dp = h.getAttribute("dp") || "15";
                gcode += `G0 X${x} Y${y}\nG1 Z-${dp} F500\nG0 Z5\n`;
            });

            gcode += "M30\n%";
            zip.file(`programs/PROG_${partId}.nc`, gcode);
        });

        // Генерируем архив
        zipResult = await zip.generateAsync({type: "blob"});
        status.innerText = "Файлы успешно подготовлены!";
        downloadBtn.style.display = "inline-block";
    }

    downloadBtn.onclick = () => {
        const a = document.createElement("a");
        a.href = URL.createObjectURL(zipResult);
        a.download = "nanxing_package.zip";
        a.click();
    };
</script>

</body>
</html>
